<div class="template-form-container">
  <div class="template-form-card">
    <div class="card-header">
      <h2>{{isEdit ? 'Sá»­a' : 'Táº¡o'}} Email Template</h2>
      <button class="close-btn" (click)="closeDialog()">Ã—</button>
    </div>

    <div *ngIf="loading" class="loading-state">
      <p>ğŸ”„ {{isEdit ? 'Äang cáº­p nháº­t...' : 'Äang táº¡o...'}}</p>
    </div>

    <!-- Success state -->
    <div *ngIf="!loading && !error && (form.get('name')?.value || form.get('code')?.value)" class="success-state">
      <p>âœ… {{isEdit ? 'Cáº­p nháº­t thÃ nh cÃ´ng!' : 'Táº¡o thÃ nh cÃ´ng!'}}</p>
    </div>

    <!-- Error state -->
    <div *ngIf="error" class="error-state">
      <p>{{ error }}</p>
    </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="template-form" *ngIf="!loading">
      <div class="form-section">
        <h3>ğŸ“ ThÃ´ng tin cÆ¡ báº£n</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label for="template-name">TÃªn Template *</label>
            <input 
              id="template-name"
              formControlName="name"
              placeholder="VÃ­ dá»¥: Order Confirmation" 
              class="form-control"
              [class.error]="form.get('name')?.invalid && form.get('name')?.touched"
            />
            <div class="error-message" *ngIf="form.get('name')?.invalid && form.get('name')?.touched">
              <span *ngIf="form.get('name')?.errors?.['required']">TÃªn template lÃ  báº¯t buá»™c</span>
              <span *ngIf="form.get('name')?.errors?.['minlength']">TÃªn template pháº£i cÃ³ Ã­t nháº¥t 2 kÃ½ tá»±</span>
              <span *ngIf="form.get('name')?.errors?.['maxlength']">TÃªn template khÃ´ng Ä‘Æ°á»£c quÃ¡ 100 kÃ½ tá»±</span>
            </div>
            <div class="error-message" *ngIf="fieldErrors['name']">
              {{ fieldErrors['name'] }}
            </div>
          </div>

          <div class="form-group">
            <label for="template-code">MÃ£ Template *</label>
            <input 
              id="template-code"
              formControlName="code"
              placeholder="VÃ­ dá»¥: ORDER_CONFIRM" 
              [readonly]="isEdit"
              class="form-control"
              [class.error]="form.get('code')?.invalid && form.get('code')?.touched"
            />
            <div class="error-message" *ngIf="form.get('code')?.invalid && form.get('code')?.touched">
              <span *ngIf="form.get('code')?.errors?.['required']">MÃ£ template lÃ  báº¯t buá»™c</span>
              <span *ngIf="form.get('code')?.errors?.['minlength']">MÃ£ template pháº£i cÃ³ Ã­t nháº¥t 2 kÃ½ tá»±</span>
              <span *ngIf="form.get('code')?.errors?.['maxlength']">MÃ£ template khÃ´ng Ä‘Æ°á»£c quÃ¡ 100 kÃ½ tá»±</span>
            </div>
            <div class="error-message" *ngIf="fieldErrors['code']">
              {{ fieldErrors['code'] }}
            </div>
            <small class="help-text" *ngIf="isEdit">
              MÃ£ template khÃ´ng thá»ƒ thay Ä‘á»•i sau khi táº¡o
            </small>
          </div>
        </div>

        <div class="form-group">
          <label for="template-subject">TiÃªu Ä‘á» Email *</label>
          <input 
            id="template-subject"
            formControlName="subject"
            placeholder="VÃ­ dá»¥: XÃ¡c nháº­n Ä‘Æ¡n hÃ ng {orderNumber}" 
            class="form-control"
            [class.error]="form.get('subject')?.invalid && form.get('subject')?.touched"
          />
          <div class="error-message" *ngIf="form.get('subject')?.invalid && form.get('subject')?.touched">
            <span *ngIf="form.get('subject')?.errors?.['required']">TiÃªu Ä‘á» email lÃ  báº¯t buá»™c</span>
            <span *ngIf="form.get('subject')?.errors?.['minlength']">TiÃªu Ä‘á» email pháº£i cÃ³ Ã­t nháº¥t 5 kÃ½ tá»±</span>
            <span *ngIf="form.get('subject')?.errors?.['maxlength']">TiÃªu Ä‘á» email khÃ´ng Ä‘Æ°á»£c quÃ¡ 255 kÃ½ tá»±</span>
          </div>
          <div class="error-message" *ngIf="fieldErrors['subject']">
            {{ fieldErrors['subject'] }}
          </div>
        </div>

        <div class="form-group">
          <label for="template-status">Tráº¡ng thÃ¡i</label>
          <select 
            id="template-status"
            formControlName="status"
            class="form-control"
          >
            <option [ngValue]="true">âœ… Báº­t</option>
            <option [ngValue]="false">âŒ Táº¯t</option>
          </select>
          <div class="error-message" *ngIf="fieldErrors['status']">
            {{ fieldErrors['status'] }}
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3>ğŸ“„ Ná»™i dung Template</h3>
        
        <div class="form-group">
          <label for="template-content">Ná»™i dung HTML *</label>
          <textarea
            id="template-content"
            formControlName="content"
            placeholder="Nháº­p ná»™i dung HTML cá»§a email..."
            rows="12"
            class="form-control content-textarea"
            [class.error]="form.get('content')?.invalid && form.get('content')?.touched"
          ></textarea>
          <div class="error-message" *ngIf="form.get('content')?.invalid && form.get('content')?.touched">
            <span *ngIf="form.get('content')?.errors?.['required']">Ná»™i dung template lÃ  báº¯t buá»™c</span>
            <span *ngIf="form.get('content')?.errors?.['minlength']">Ná»™i dung template pháº£i cÃ³ Ã­t nháº¥t 10 kÃ½ tá»±</span>
            <span *ngIf="form.get('content')?.errors?.['maxlength']">Ná»™i dung template khÃ´ng Ä‘Æ°á»£c quÃ¡ 10000 kÃ½ tá»±</span>
          </div>
          <div class="error-message" *ngIf="fieldErrors['content']">
            {{ fieldErrors['content'] }}
          </div>
          <small class="help-text">
            Sá»­ dá»¥ng cÃº phÃ¡p <b>{{ '{' }}{{ '{ten_bien}' }}{{ '}' }}</b> trong ná»™i dung Ä‘á»ƒ thÃªm biáº¿n Ä‘á»™ng vÃ o template
          </small>
        </div>
      </div>

      <div class="form-section" *ngIf="Object.keys(placeholders).length > 0">
        <h3>ğŸ”§ Biáº¿n Ä‘á»™ng (Placeholders)</h3>
        
        <div class="placeholders-container">
          <div class="placeholder-item" *ngFor="let key of Object.keys(placeholders)">
            <div class="placeholder-header">
              <span class="placeholder-key">{{key}}</span>
              <button type="button" class="remove-btn" (click)="removePlaceholder(key)" title="XÃ³a placeholder">Ã—</button>
            </div>
            <input 
              type="text" 
              [value]="variables[key] || ''"
              (input)="updatePlaceholderValue(key, $any($event.target).value)"
              placeholder="Nháº­p giÃ¡ trá»‹ cho {{key}}"
              class="placeholder-input"
            />
          </div>
        </div>

        <div class="add-placeholder">
          <input 
            type="text" 
            [(ngModel)]="newPlaceholder"
            placeholder="ThÃªm placeholder má»›i"
            class="form-control"
            (keyup.enter)="addPlaceholder()"
          />
          <button type="button" class="add-btn" (click)="addPlaceholder()">â• ThÃªm</button>
        </div>
      </div>

      <div class="form-section" *ngIf="previewHtml">
        <h3>ğŸ‘ï¸ Xem trÆ°á»›c</h3>
        <div class="preview-container">
          <div class="notification-preview" [innerHTML]="previewHtml"></div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="closeDialog()" [disabled]="loading">
          âŒ Há»§y
        </button>
        <button type="submit" class="save-btn" [disabled]="form.invalid || loading">
          <span *ngIf="!loading">{{isEdit ? 'ğŸ’¾ Cáº­p nháº­t' : 'âœ¨ Táº¡o'}}</span>
          <span *ngIf="loading">ğŸ”„ {{isEdit ? 'Äang cáº­p nháº­t...' : 'Äang táº¡o...'}}</span>
        </button>
      </div>
    </form>
  </div>
</div> 